# 운영체제: 프로세스 관리
> ✅ 교착 상태

## <br> 1. 교착 상태 개요
### 1.1 교착 상태란?
> 2개 이상의 프로세스가 다른 프로세스의 작업이 끝나기만 기다리며 작업을 더 이상 진행하지 못하는 상태.

<img width="409" alt="스크린샷 2023-05-17 오후 8 12 18" src="https://github.com/YangYubin12/OperatingSystem/assets/102217712/9ade4673-44ff-451a-b127-50ca88fd20e7">

![image](https://github.com/YangYubin12/OperatingSystem/assets/102217712/081276a4-73aa-401d-bb9a-544b0f2bdd8f)

> 교착상태를 온몸으로 보여주는 사진

### 1.2 아사 상태와의 차이점
* 아사 현상 : 운영체제가 잘못된 정책을 사용하여 특정 프로세스의 작업이 지연되는 문제.
* 교착 상태 : 여러 프로세스가 작업을 진행하다 보니 자연 발생적으로 일어나는 문제.

### 1.3 시스템 자원 및 공유 변수
* 시스템 자원: 교착 상태는 다른 프로세스와 공유할 수 없는 자원을 사용할 때 발생.

<img width="623" alt="스크린샷 2023-05-17 오후 8 16 49" src="https://github.com/YangYubin12/OperatingSystem/assets/102217712/958ddf8b-e272-4673-a3a8-fd8c81ce5cc3">

* 공유 변수: 교착 상태는 공유 변수를 사용할 때 발생.

### 1.4 응용 프로그램
* 데이터베이스 같은 응용 프로그램에서도 교착 상태 발생.
* 데이터베이스는 데이터의 일관성을 유지하기 위해 잠금을 사용하는데, 이때 교착 상태가 발생할 수 있음.

### 1.5 자원 할당 그래프
* 프로세스가 어떤 자원을 사용 중이고 어떤 자원을 기다리고 있는지를 방향성이 있는 그래프로 표현한 것.
* 프로세스는 원으로, 자원은 사각형으로 표현.

<img width="446" alt="스크린샷 2023-05-17 오후 8 21 03" src="https://github.com/YangYubin12/OperatingSystem/assets/102217712/ea9c5348-8194-41d0-bb20-ec32fbffba7b">

### 1.6 다중 자원
* 여러 프로세스가 하나의 자원을 동시에 사용하는 경우.
* 수용할 수 있는 프로세스 수를 사각형 안에 작은 동그라미로 표현.

### 1.7 식사하는 철학자 문제
> 왼쪽에 있는 포크를 잡은 뒤 오른쪽에 있는 포크를 잡아야만 식사 가능.

![image](https://github.com/YangYubin12/OperatingSystem/assets/102217712/92ec451d-6339-4742-b05b-b7e1b4d328a8)

만약 모든 철학자들이 동시에 자신의 왼쪽 포크를 잡는다면, 모든 철학자들이 자기 오른쪽의 포크가 사용 가능해질 때까지 기다려야 한다.
<br>그런데 모든 철학자들이 그러고 있다. 
<br>이 상태에서는 모든 철학자가 영원히 오른쪽 포크가 사용 가능해질 때까지 대기하며 만약 사용 가능하다면 집어드는 상태에 머물러있어 아무것도 진행할 수가 없게 되는데, 이것이 교착(Deadlock)상태이다.

#### 식사하는 철학자 문제에서 교착 상태가 발생하는 조건
* 철학자들은 서로 포크를 공유할 수 없음.
    → 자원을 공유하지 못하면 교착 상태가 발생.

* 각 철학자는 다른 철학자의 포크를 빼앗을 수 없음.
    → 자원을 빼앗을 수 없으면 자원을 놓을 때까지 기다려야 하므로 교착 상태가 발생.

* 각 철학자는 왼쪽 포크를 잡은 채 오른쪽 포크를 기다림.
    → 자원 하나를 잡은 상태에서 다른 자원을 기다리면 교착 상태가 발생.

* 자원 할당 그래프가 원형.
    → 자원을 요구하는 방향이 원을 이루면 양보를 하지 않기 때문에 교착 상태가 발생.
    
## <br> 2. 교착 상태 필요 조건
### 2.1 교착 상태 필요 조건?
#### 다음 4가지 조건이 모두 발생해야만 교착상태 발생.(필요조건) 4가지 중 단 한가지라도 만족하지 않으면 교착상태가 발생하지 않음.

```
- 상호 배제(mutual exclusion) : 한 프로세스가 사용하는 자원은 다른 프로세스와 공유할 수 없는 배타적인 자원이어야 함.
- 비선점(non-preemptive) : 한 프로세스가 사용 중인 자원은 중간에 다른 프로세스가 빼앗을 수 없는 비선점 자원이어야 함
- 점유와 대기(hold and wait) : 프로세스가 어떤 자원을 할당받은 상태에서 다른 자원을 기다리는 상태여야 함.
- 원형 대기(circular wait) : 점유와 대기를 하는 프로세스 간의 관계가 원을 이루어야 함.
```

### 2.2 교착 상태 필요 조건 분석
* 상호 배제, 비선점 조건 : 자원이 어떤 특징을 가지는지를 나타냄.
* 점유와 대기, 원형 대기 조건 : 프로세스가 어떤 행위를 하고 있는지를 나타냄.

### 2.3 식사하는 철학자 문제와 교착 상태 필요 조건
* 상호 배제 
  - 포크는 한 사람이 사용하면 다른 사람이 사용할 수 없는 배타적인 자원임.
* 비선점
  - 철학자 중 어떤 사람의 힘이 월등하여 옆 사람의 포크를 빼앗을 수 없음.
* 점유와 대기 
  - 한 철학자가 두 자원(왼쪽 포크와 오른쪽 포크)을 다 점유하거나, 반대로 두 자원을 다 기다릴 수 없음.
* 원형 대기 
  - 철학자들은 둥그런 식탁에서 식사를 함, 원을 이룬다는 것은 선후 관계를 결정할 수 없어 문제가 계속 맴돈다는 의미.

## <br> 3. 교착 상태 해결 및 예방 방법
### 3.1 교착 상태 해결 방법
* <b>교착 상태 예방(prevention)</b>: 교착 상태를 유발하는 네 가지 조건이 발생하지 않도록 무력화하는 방식으로 교착상태 조선 4가지에 대하여 각각의 방법이 존재 함.
* <b>교착 상태 회피(avoidance)</b>: 교착상태가 발생하지 않도록 자원 할당량을 조절하여 교착 상태를 회피하는 방식.
  ![image](https://github.com/YangYubin12/OperatingSystem/assets/102217712/e8262dbf-8da8-4125-b83f-497c2bf0a2a8)
  회피하기!
* <b>교착 상태 검출(detection)과 회복(recovery)</b>: 교착 상태 검출은 어떤 제약을 가하지 않고 자원 할당 그래프를 모니터링하면서 교착 상태가 발생하는지 살펴보는 방식으로 만약 교착 상태가 발생하면 교착 상태 회복 단계가 진행됨.

### 3.2 교착 상태 조건 4가지에 대한 각각의 방식
### 상호 배제 예방 
* 시스템 내에 있는 상호 배타적인 모든 자원, 즉 독점적으로 사용할 수 있는 자원을 없애버리는 방법.
* 현실적으로는 모든 자원을 공유할 수 없으며 상호 배제를 적용하여 보호해야 하는 자원이 있음.
* 상호 배제를 무력화하는 것은 사실상 어려움.

### 비선점 예방 
* 모든 자원을 빼앗을 수 있도록 만드는 방법.
* 그러나 아사 현상을 일으켜 비선점 조건을 무력화하기는 어려움.

### 점유와 대기 예방
* 프로세스가 자원을 점유한 상태에서 다른 자원을 기다리지 못하게 하는 방법.
* ‘전부 할당하거나 아니면 아예 할당하지 않는’ 방식을 적용.
* 자원이 아닌 프로세스의 자원 사용 방식을 변화시켜 교착 상태를 처리한다는 점에서 의미가 있음.
* <img width="414" alt="스크린샷 2023-05-18 오전 10 32 00" src="https://github.com/YangYubin12/OperatingSystem/assets/102217712/cba019a9-e1ff-4b0c-87e9-7f584bdc2590">
* <b>점유와 대기 예방의 단점</b>
  - 프로세스가 자신이 사용하는 모든 자원을 자세히 알기 어려움.
  - 자원의 활용성이 떨어짐.
  - 많은 자원을 사용하는 프로세스가 적은 자원을 사용하는 프로세스보다 불리함.
  - 결국 일괄 작업 방식으로 동작.
  
### 원형 대기 예방
* 점유와 대기를 하는 프로세스들이 원형을 이루지 못하도록 막는 방법.
* 모든 자원에 숫자를 부여하고 숫자가 큰 방향으로만 자원을 할당하는 것.
* 예) 마우스를 할당받은 상태에서 프린터를 할당받을 수는 있지만 프린터를 할당받은 상태에서는 마우스나 하드디스크를 할당받을 수 없음.
* 원형 대기 예방과 교착 상태 해결
   - 프로세스 P2는 자원을 할당받을 수 없어 강제 종료되고 프로세스 P1은 정상적으로 실행.
* 원형 대기 예방의 단점
   - 프로세스 작업 진행에 유연성이 떨어짐.
   - 자원의 번호를 어떻게 부여할 것인지가 문제.

### 3.3 교착 상태 예방 정리
* 교착 상태를 유발하는 네 가지 조건이 일어나지 않도록 제약을 가하는 방법.
* 자원을 보호하기 위해 상호 배제와 비선점을 예방하기 어려움.
* 점유와 대기, 원형 대기는 프로세스 작업 방식을 제한하고 자원을 낭비하기 때문에 사용할 수 없음.

## <br> 4. 교착 상태 회피
### 4.1 교착 상태 회피의 개념
* 프로세스에 자원을 할당할 때 어느 수준 이상의 자원을 나누어주면 교착 상태가 발생하는지 파악하여 그 수준 이하로 자원을 나누어주는 방법.
* 교착 상태가 발생하지 않는 범위 내에서만 자원을 할당하고, 교착 상태가 발생하는 범위에 있으면 프로세스를 대기시킴.
* 즉, 할당되는 자원의 수를 조절하요 교착 상태를 피함.

### 4.2 안정 상태와 불안정 상태
* 교착 상태 회피는 자원의 총수와 현재 할당된 자원의 수를 기준으로 시스템을 안정 상태safe state와 불안정 상태unsafe state로 나누고 시스템이 안정 상태를 유지하도록 자원을 할당.
* 할당된 자원이 적으면 안정 상태가 크고, 할당된 자원이 늘어날수록 불안정 상태가 커짐.
* 교착 상태는 불안정 상태의 일부분이며, 불안정 상태가 커질수록 교착 상태가 발생할 가능성이 높아짐.
* 교착 상태 회피는 안정 상태를 유지할 수 있는 범위 내에서 자원을 할당함으로써 교착 상태를 피함. 

<img width="414" alt="스크린샷 2023-05-18 오후 7 28 49" src="https://github.com/YangYubin12/OperatingSystem/assets/102217712/1a287ce9-bd2b-4d1f-bda9-77c532cd4e9a">

### 4.3 은행원 알고리즘
* 교착 상태 회피를 구현하는 대표적인 알고리즘.
* 은행이 대출을 해주는 방식, 즉 대출 금액이 대출 가능한 범위 내이면(안정 상태이면) 허용되지만 그렇지 않으면 거부되는 것과 유사한 방식.

![image](https://github.com/YangYubin12/OperatingSystem/assets/102217712/d7074deb-4a3a-451e-9dcf-a36db51f86c7)

![image](https://github.com/YangYubin12/OperatingSystem/assets/102217712/91541f14-f0e1-435e-9c07-2bcf1560767a)
* 시스템이 안전상태를 유지할 수 있게 하는 것이 은행원 알고리즘이다.

<img width="848" alt="스크린샷 2023-05-18 오후 7 42 04" src="https://github.com/YangYubin12/OperatingSystem/assets/102217712/100b9738-f179-4931-a654-61553236ef6a">

* 은행원 알고리즘에서 자원 할당 기준 
  - 각 프로세스의 기대 자원과 비교하여 가용 자원이 하나라도 크거나 같으면 자원을 할당.
  - 가용 자원이 어떤 기대 자원보다 크지 않으면 할당하지 않음.

### 4.4 교착 상태 회피의 문제점
* 프로세스가 자신이 사용할 모든 자원을 미리 선언해야 함.
* 시스템의 전체 자원 수가 고정적이어야 함.
* 자원이 낭비됨.

## <br> 5. 교착 상태 검출
### 5.1 교착 상태 검출의 개념
* 운영체제가 프로세스의 작업을 관찰하면서 교착 상태 발생 여부를 계속 주시하는 방식.
* 교착 상태가 발견되면 이를 해결하기 위해 교착 상태 회복 단계를 밟음.

### 5.2 타임아웃을 이용한 교착 상태 검출
* 일정 시간 동안 작업이 진행되지 않은 프로세스를 교착 상태가 발생한 것으로 간주하여 처리하는 방법.
* 교착 상태가 자주 발생하지 않을 것이라는 가정하에 사용하는 것으로, 특별한 알고리즘이 없어 쉽게 구현할 수 있음.
* 타임아웃이 되면 프로세스가 종료됨.
* 타임 아웃을 이용한 방법의 예:

  <img width="322" alt="스크린샷 2023-05-18 오후 7 49 56" src="https://github.com/YangYubin12/OperatingSystem/assets/102217712/761fc1ff-2de2-427b-acb8-400441247589">

### 5.3 데이터베이스에서 타임아웃의 문제
* 데이터베이스에서 타임아웃으로 프로세스가 종료되면 일부 데이터의 일관성이 깨질 수 있음.
* 데이터의 일관성이 깨지는 문제를 해결하기 위해 체크포인트와 롤백 사용.
  - 체크포인트 : 작업을 하다가 문제가 발생하면 저장된 상태로 돌아오기 위한 표시.
  - 롤백 : 작업을 하다가 문제가 발생하여 과거의 체크포인트로 되돌아가는 것.
 
### 5.4 자원 할당 그래프를 이용한 교착 상태 검출
단일 자원을 사용하는 경우 자원 할당 그래프에 사이클 있으면 교착 상태.

<img width="729" alt="스크린샷 2023-05-18 오후 7 54 48" src="https://github.com/YangYubin12/OperatingSystem/assets/102217712/de5318b4-7fc2-4aab-9b78-dd6ccf465362">

## <br> 6. 교착 상태 회복
### 6.1 교착 상태 회복이란?
> 교착 상태가 검출된 후 교착 상태를 푸는 후속 작업을 하는 것.
> 교착 상태 회복 단계에서는 교착 상태를 유발한 프로세스를 강제로 종료.
* 프로세스를 강제로 종료하는 방법
  - 교착 상태를 일으킨 모든 프로세스를 동시에 종료.
  - 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료.
    + 우선순위가 낮은 프로세스를 먼저 종료.
    + 우선순위가 같은 경우 작업 시간이 짧은 프로세스를 먼저 종료.
    + 위의 두 조건이 같은 경우 자원을 많이 사용하는 프로세스를 먼저 종료.

## <br> 7. 다중 자원과 교착 상태 검출
### 7.1 다중 자원과 사이클
다중 자원이 포함된 자원 할당 그래프에서는 대기 그래프와 그래프 감소 방법을 이용하여 사이클을 찾음.

### 7.2 대기 그래프
자원 할당 그래프에서 프로세스와 프로세스 간에 기다리는 관계만 나타낸 그래프.

![image](https://github.com/YangYubin12/OperatingSystem/assets/102217712/cb0194c9-2f71-4839-9b7b-c8712520aa9f)


### 7.3 그래프 감소
대기 그래프에서 작업이 끝날 가능성이 있는 프로세스의 화살표와 관련 프로세스의 화살표를 연속적으로 지워가는 작업.

### 7.4 다중 자원 사용 시 교착 상태가 발생하지 않는 경우
그래프 감소 결과 사이클이 남아 있지 않으므로 교착 상태가 발생하지 않음.

<img width="806" alt="스크린샷 2023-05-18 오후 8 05 33" src="https://github.com/YangYubin12/OperatingSystem/assets/102217712/6d7bca0f-ff70-49c5-89eb-5e7ccd6094e5">

### 7.5 다중 자원 지원 시 교착 상태가 발생하는 경우
그래프 감소를 해도 여전히 사이클이 남아 있어 교착 상태가 발생.

<img width="833" alt="스크린샷 2023-05-18 오후 8 06 27" src="https://github.com/YangYubin12/OperatingSystem/assets/102217712/53844c85-6a67-4c2d-8981-d3b35e03ec71">

<br>

## 출처
* [출처 1: 운영체제 11장-프로세스 관리(8):교착상태(Deadlock)](https://copycode.tistory.com/72)
* [출처 2: 데드락(Deadlock) 개념 정리](https://kukuta.tistory.com/281) &nbsp; 
* [출처 3: 식사하는 철학자 문제](https://namu.wiki/w/%EC%8B%9D%EC%82%AC%ED%95%98%EB%8A%94%20%EC%B2%A0%ED%95%99%EC%9E%90%20%EB%AC%B8%EC%A0%9C)
* [출처 4: [운영체제]식사하는 철학자 문제](https://velog.io/@minseojo/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C-%EC%8B%9D%EC%82%AC%ED%95%98%EB%8A%94-%EC%B2%A0%ED%95%99%EC%9E%90-%EB%AC%B8%EC%A0%9C)
* [출처 5: [운영체제]교착상태](https://velog.io/@cheal3/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C-%EA%B5%90%EC%B0%A9%EC%83%81%ED%83%9C)
* [출처 6: 은행원 알고리즘?](https://velog.io/@seorim0801/%EC%9D%80%ED%96%89%EC%9B%90-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98)
* 출처 7: ch06_교착상태 PPT
